<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>videojs-http-streaming Demo</title>
  <link href="node_modules/video.js/dist/video-js.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .info {
      background-color: #eee;
      border: thin solid #333;
      border-radius: 3px;
      padding: 0 5px;
      margin: 20px 0;
    }
    input {
      margin-top: 15px;
      min-width: 450px;
      padding: 5px;
    }
  </style>

</head>
<body>
  <video-js id="videojs-http-streaming-player" class="vjs-default-skin" controls></video-js>
  <div>
  <br>
  <label>
    Debug Logging
    <input id=debug-logging type="checkbox" checked>
  </div>

  <h3>Input a source</h3>
  <form id=load-url>
    <label>
      Video URL:
      <input id=url type=url value="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8">
    </label>
    <button type=submit>Load</button>
  </form>
  <h3>Select a source</h3>
  <form id=select-source>
    <label>
      Video:
      <select id=source>
        <optgroup label="hls">
          <option value="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8">Muxed TS with 1 alt Audio, 5 captions</option>
          <option value="https://d2zihajmogu5jn.cloudfront.net/ts-fmp4/index.m3u8">FMP4 and ts both muxed</option>
          <option value="https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_fmp4/master.m3u8">FMP4 and captions muxed</option>
          <option value="https://devstreaming-cdn.apple.com/videos/streaming/examples/bipbop_adv_example_hevc/master.m3u8">FMP4 hevc</option>
          <option value="https://storage.googleapis.com/shaka-demo-assets/angel-one-hls/hls.m3u8">FMP4 unmuxed, many audio/captions</option>
          <option value="https://bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s-fmp4/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8">FMP4 unmuxed</option>
          <option value="https://s3.amazonaws.com/bob.jwplayer.com/~alex/121628/new_master.m3u8">ts Audio only</option>

          <option value="https://akamai-axtest.akamaized.net/routes/lapd-v1-acceptance/www_c4/Manifest.m3u8">ts Live</option>
          <option value="https://playertest.longtailvideo.com/adaptive/oceans_aes/oceans_aes.m3u8">ts Encrypted</option>
        </optgroup>
        <optgroup label="dash">
          <option value="https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd">unmuxed audio/video</option>
          <option value="https://vm2.dashif.org/livesim/mup_30/testpic_2s/Manifest.mpd">Live</option>
          <option value="https://dash.akamaized.net/dash264/TestCases/10a/1/iis_forest_short_poem_multi_lang_480p_single_adapt_aaclc_sidx.mpd">Sidx unmuxed, 2 audio</option>
        </optgroup>
      </select>
    </label>
    <button type=submit>Load</button>
  </form>
  <ul>
    <li><a href="index.min.html">Use minified JavaScript.</a></li>
    <li><a href="test/">Run unit tests in browser.</a></li>
    <li><a href="docs/api/">Read generated docs.</a></li>
    <li><a href="examples">Browse Examples</a></li>
  </ul>

  <script src="node_modules/video.js/dist/alt/video.core.js"></script>
  <script src="node_modules/videojs-contrib-eme/dist/videojs-contrib-eme.js"></script>

  <script src="dist/videojs-http-streaming.js"></script>
  <script>

    // taken from video.js
    var getFileExtension = function(path) {
      if (typeof path === 'string') {
        var splitPathRe = /^(\/?)([\s\S]*?)((?:\.{1,2}|[^\/]+?)(\.([^\.\/\?]+)))(?:[\/]*|[\?].*)$/i;
        var pathParts = splitPathRe.exec(path);

        if (pathParts) {
          return pathParts.pop().toLowerCase();
        }
      }

      return '';
    };
    (function(window, videojs) {
      var player = window.player = videojs('videojs-http-streaming-player', {
        html5: {
          hls: {
            overrideNative: !videojs.browser.IS_SAFARI
          }
        }
      });

      // configure videojs-contrib-eme
      player.eme();

      // hook up the video switcher
      var loadUrl = document.getElementById('load-url');
      var url = document.getElementById('url');
      var selectSource = document.getElementById('select-source');
      var source = document.getElementById('source');
      var debugLogging = document.getElementById('debug-logging');


      // set loadUrl to default source.
      url.value = source.options[0].value;
      var saveState = function() {
        if (window.history.replaceState) {
          window.history.replaceState(null, null,
            '?debug=' + (debugLogging.checked ? 'true' : 'false') +
            '&url=' + encodeURIComponent(url.value)
          )
        }
      };

      if (URLSearchParams) {
        var params = new URLSearchParams(window.location.search)
        var queryUrl = params.get('url');
        var queryDebug = params.get('debug');

        // if there is a "url" param in the query params set url
        // and selected index to that
        if (queryUrl) {
          url.value = queryUrl;
          Array.prototype.forEach.call(source.options, function(s, i) {
            if (s.value === queryUrl) {
              source.selectedIndex = i;
            }
          });
        }

        if (queryDebug) {
          debugLogging.checked = queryDebug === "false" ? false : true;
        }
      }

      debugLogging.addEventListener('change', function(event) {
        saveState();
        if (event.target.checked) {
          videojs.log.level('debug');
        } else {
          // restore default level
          videojs.log.level('info')
        }
      });

      loadUrl.addEventListener('submit', function(event) {
        event.preventDefault();

        var type = 'application/x-mpegURL';

        if (getFileExtension(url.value) === 'mpd') {
          type = 'application/dash+xml';
        }

        saveState();

        player.src({
          src: url.value,
          type: type
        });
        return false;
      });

      // run the change handler for the first time
      debugLogging.dispatchEvent(new CustomEvent('change'));

      // run the load url handler for the intial source
      loadUrl.dispatchEvent(new CustomEvent('submit'));

      selectSource.addEventListener('submit', function(event) {
        event.preventDefault();
        url.value = source.options[source.selectedIndex].value;
        loadUrl.dispatchEvent(new CustomEvent('submit'));
        return false;
      });

    }(window, window.videojs));
  </script>
</body>
</html>
